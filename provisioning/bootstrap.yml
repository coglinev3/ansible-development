---
# file: bootstrap.yml

- hosts: management_node
  become: true
  roles:
    - { role: coglinev3.vagrant-ansible-init }

- hosts: ubuntu_trusty_nodes
  gather_facts: False
  become: true
  # This will install python2 if missing on ubuntu (but checks first so no expensive repeated
  # apt updates)
  # Thanks for discussion on https://gist.github.com/gwillem/4ba393dceb55e5ae276a87300f6b8e6f
  pre_tasks:
    - name: Install python for Ansible
      raw: test -e /usr/bin/python || (apt -y update && apt install -y python-minimal)
      register: output
      changed_when: output.stdout != ""
    - name: Gather facts for Ubuntu Trusty
      setup: # aka gather_facts

- hosts: ubuntu_nodes:!ubuntu_trusty_nodes
  gather_facts: False
  become: true
  pre_tasks:
    - name: Install python3 for Ansible
      raw: test -e /usr/bin/python3 || (apt -y update && apt install -y python3-minimal)
      register: output
      changed_when: output.stdout != ""
    - name: Gather facts for Ubuntu host(s)
      setup: # aka gather_facts

- hosts: alpine_nodes
  gather_facts: False
  become: true
  # This will install python if missing on Alpine
  pre_tasks:
    - name: Install dhclinet
      raw:  test -e /usr/sbin/dhclient || (apk update && apk add dhclient)
      register: dhclient
      changed_when: dhclient.stdout != ""
    - name: Install python for Ansible
      raw: test -e /usr/bin/python3 || (apk update && apk add python3)
      register: python
      changed_when: python.stdout != ""
    - name: Gather facts for Alpine host(s)
      setup: # aka gather_facts

- hosts: el8_nodes
  gather_facts: False
  become: true
  pre_tasks:
    - name: Install python3 for Ansible
      raw: test -e /usr/bin/python3 || (yum -y update && yum install -y python3)
      register: output
      changed_when: output.stdout != ""
    - name: Gather facts for EL host(s)
      setup: # aka gather_facts

- hosts: os
  become: true
  roles:
    - { role: coglinev3.ansible-common }
    - { role: sansible.users_and_groups }
    # - { role: geerlingguy.dotfiles }
